# Claude Development Notes

Essential development notes for working with Claude on Chroxy.

## Project Overview

**Chroxy** is a remote terminal app for Claude Code. Run a lightweight daemon on your dev machine, connect from your phone via a secure tunnel. Get both a full terminal view and a clean chat-like UI that parses Claude Code's output into readable messages.

**Tech Stack:** Node.js (server), React Native/Expo (mobile app), WebSocket over Cloudflare tunnel

**Architecture:** Monorepo with npm workspaces

```
chroxy/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ server/     # Node.js daemon + CLI (ES modules, no TypeScript)
‚îÇ   ‚îî‚îÄ‚îÄ app/        # React Native mobile app (TypeScript, Expo 54)
‚îú‚îÄ‚îÄ docs/           # Setup guides, architecture
‚îî‚îÄ‚îÄ scripts/        # Install helpers
```

**Current Status (v0.1.0):**
- Server works: CLI headless mode (default), PTY/tmux mode, WebSocket protocol, Cloudflare tunnel (Quick + Named), supervisor auto-restart, push notifications, session management, model switching, auto-discovery, plan mode detection, background agent tracking
- App works: QR code scanning, connection flow with health checks and retries, ConnectionPhase state machine for resilient reconnection, markdown rendering, dual-view chat/terminal, plan approval UI, agent monitoring, settings screen
- Priority: xterm.js integration, permission handling UI improvements

## Critical Dev Notes

### Node 22 Required

**node-pty does not compile on Node 25.** Always use Node 22:

```bash
PATH="/opt/homebrew/opt/node@22/bin:$PATH" npx chroxy start
```

Or prefix any npm/node commands with the Node 22 path when running the server.

### tmux Dependency (PTY mode only)

tmux is only required when using `--terminal` flag (PTY mode). The default CLI headless mode does not require tmux.

```bash
brew install tmux
```

### Cloudflare Tunnel Dependency

The server uses Cloudflare tunnels for secure remote access. Two modes:
- **Quick Tunnel** (default): random URL, no account needed
- **Named Tunnel** (`--tunnel named`): stable URL, requires Cloudflare account + domain

```bash
brew install cloudflared

# Named tunnel setup (interactive):
npx chroxy tunnel setup
```

## Session Start Protocol

**When user says "Resume" or "Let's start":**
1. `cat CLAUDE.md` - Read this file
2. `git status && git log --oneline -5` - Check current state
3. Review any open PRs: `gh pr list`
4. Check for skill template updates: `~/Projects/skill-templates/sync.sh chroxy`

### Skill Templates

Reusable skill templates (check-pr, agent-review, etc.) are maintained in the private repo `blamechris/skill-templates`. When the sync script reports drift, review the generic template and customization notes, then update local skills as needed.

```
~/Projects/skill-templates/
‚îú‚îÄ‚îÄ generic/           # Gold standard templates
‚îú‚îÄ‚îÄ customizations/    # Per-repo adaptation notes (chroxy.md)
‚îî‚îÄ‚îÄ sync.sh           # Drift detection
```

## Git Workflow

### Zero Attribution Policy

**CRITICAL - READ THIS FIRST:**

Claude must NEVER include ANY of the following in commits, PRs, or any files:
- `Co-Authored-By: Claude` or any Claude co-author line
- `Generated with Claude Code` or similar phrases
- `Generated by Claude` or `Created by Claude`
- Any emoji + "Generated with" pattern
- Any mention of Claude, Anthropic, or AI assistance in commit messages
- Any attribution in PR descriptions

**The user is the SOLE AUTHOR of all work. Period.**

Commit messages should be clean and professional:
```
feat(server): add graceful shutdown on SIGTERM

- Clean up tmux session on exit
- Close WebSocket connections
```

NOT:
```
feat: Add feature

ü§ñ Generated with [Claude Code](...)

Co-Authored-By: Claude...
```

### Branch Naming

```
feat/feature-name         # New features
fix/issue-description     # Bug fixes
refactor/component        # Refactoring
docs/topic                # Documentation
test/test-description     # Test additions
```

### Commit Message Format

```
type(scope): Short summary in present tense

[Optional body with details]
```

**Types:** feat, fix, refactor, docs, test, chore, style, perf
**Scopes:** server, app, parser, tunnel, ws, cli, docs

### PR Workflow

**CRITICAL: NEVER commit directly to main.** Always use feature branches and PRs.

1. Create feature branch from `main`
2. Develop and test
3. Push and create PR
4. Get user confirmation before merging
5. Squash merge to main

**NEVER auto-merge.** Always present a summary and wait for explicit user confirmation.

## Code Style

### Server (packages/server/)

- ES modules (`import`/`export`)
- No TypeScript ‚Äî plain JavaScript
- No semicolons
- Single quotes for strings
- EventEmitter pattern for component communication

### App (packages/app/)

- TypeScript (strict)
- Functional components with hooks
- Zustand for state management
- React Navigation for routing

## Architecture

### Server Modes

Chroxy server operates in two modes:

**CLI Headless Mode (default):**
- Uses `server-cli.js` + `cli-session.js`
- Wraps `claude -p --input-format stream-json --output-format stream-json`
- No tmux or node-pty required
- Maintains conversation state internally via persistent process (does not use `--resume` flag)
- Processes streaming JSON events

**PTY/tmux Mode (opt-in with `--terminal`):**
- Uses `server.js` + `pty-manager.js` + `output-parser.js`
- Spawns tmux session running Claude Code
- Requires node-pty and tmux
- Parses raw terminal output with ANSI handling

### Server Components

| Component | File | Purpose |
|-----------|------|---------|
| CLI | `src/cli.js` | `init`, `start`, `config`, `tunnel setup` commands |
| Config | `src/config.js` | Schema validation + merge (CLI > ENV > file > defaults) |
| Supervisor | `src/supervisor.js` | Tunnel owner + child auto-restart (named tunnel mode) |
| ServerCLI | `src/server-cli.js` | CLI mode orchestrator |
| CliSession | `src/cli-session.js` | Claude Code headless executor (stream-json) |
| SdkSession | `src/sdk-session.js` | Claude Agent SDK executor |
| Server | `src/server.js` | PTY mode orchestrator |
| WsServer | `src/ws-server.js` | WebSocket protocol with auth |
| PushManager | `src/push.js` | Push notifications via Expo Push API (CLI mode) |
| PtyManager | `src/pty-manager.js` | tmux session management (PTY mode) |
| OutputParser | `src/output-parser.js` | Terminal output parser (PTY mode) |
| NoisePatterns | `src/noise-patterns.js` | Terminal noise filter patterns (PTY mode) |
| TunnelManager | `src/tunnel.js` | Cloudflare tunnel lifecycle (quick/named/none) |
| TunnelEvents | `src/tunnel-events.js` | Tunnel event wiring helpers |
| SessionManager | `src/session-manager.js` | Session lifecycle management + auto-discovery |
| SessionDiscovery | `src/session-discovery.js` | tmux session discovery utilities |
| Models | `src/models.js` | Model switching utilities |
| Logger | `src/logger.js` | Shared logging utility |

### Data Flow

**CLI Headless Mode:**
```
[Mobile App] ‚ÜêWebSocket‚Üí [Cloudflare] ‚Üê‚Üí [WsServer]
                                            ‚Üï
                                      [CliSession]
                                            ‚Üï
                              [claude -p --output-format stream-json]
                                            ‚Üï
                                    [Streaming JSON Events]
```

**PTY/tmux Mode:**
```
[Mobile App] ‚ÜêWebSocket‚Üí [Cloudflare] ‚Üê‚Üí [WsServer]
                                            ‚Üï
                                  [PtyManager] ‚Üí [OutputParser]
                                       ‚Üï              ‚Üï
                                  [tmux/Claude]   [Parsed Messages]
```

### WebSocket Protocol

Client ‚Üí Server: `auth`, `input`, `resize`, `mode`, `interrupt`, `set_model`, `set_permission_mode`, `permission_response`, `list_sessions`, `switch_session`, `create_session`, `destroy_session`, `rename_session`, `discover_sessions`, `attach_session`, `trigger_discovery`, `register_push_token`, `user_question_response`, `list_directory`
Server ‚Üí Client: `auth_ok`, `auth_fail`, `server_mode`, `stream_start`, `stream_delta`, `stream_end`, `raw`, `message`, `status`, `model_changed`, `status_update`, `available_models`, `permission_request`, `confirm_permission_mode`, `permission_mode_changed`, `available_permission_modes`, `session_list`, `session_switched`, `session_created`, `session_destroyed`, `session_error`, `discovered_sessions`, `discovery_triggered`, `history_replay_start`, `history_replay_end`, `raw_background`, `claude_ready`, `tool_start`, `result`, `agent_busy`, `agent_idle`, `agent_spawned`, `agent_completed`, `server_status`, `server_error`, `user_question`, `plan_started`, `plan_ready`, `client_joined`, `client_left`, `primary_changed`, `directory_listing`

`list_directory` requests a directory listing for the file browser; `directory_listing` returns sorted non-hidden subdirectories (or an error). `server_status` is used for non-error status updates, while `server_error` is reserved for error conditions. `discovered_sessions` can be sent proactively when auto-discovery finds new tmux sessions (configurable via `--discovery-interval`, default 45s). `trigger_discovery` requests an immediate discovery scan. `permission_request` includes an `input` field (always present, defaults to `{}`) with structured tool input for rich UI rendering. `user_question` forwards `AskUserQuestion` prompts from plan mode; `user_question_response` sends the user's answer back. `agent_spawned` fires when the Task tool is detected (description truncated to 200 chars); `agent_completed` fires per-agent when the turn's `result` arrives or on process crash/destroy. `plan_started` fires when Claude enters plan mode (`EnterPlanMode` tool); `plan_ready` fires when the plan is complete and awaiting approval (`ExitPlanMode` tool), includes `allowedPrompts` payload. These are transient events (not recorded in history or replayed). `auth` accepts optional `deviceInfo: { deviceId, deviceName, deviceType, platform }` for multi-client awareness. `auth_ok` includes `clientId` (assigned ID) and `connectedClients` (list of all connected clients). `client_joined` broadcasts to existing clients when a new client authenticates. `client_left` broadcasts when a client disconnects. `primary_changed` broadcasts last-writer-wins primary status per session (fires on `input`). `set_permission_mode` accepts optional `confirmed: true` (required for `auto` mode); without it, server responds with `confirm_permission_mode` challenge containing a `warning` string. App must show the warning and re-send with `confirmed: true` to apply.

### App Screens

| Screen | Purpose |
|--------|---------|
| ConnectScreen | QR scan or manual URL/token entry |
| SessionScreen | Dual-view: chat mode + terminal mode |
| SettingsScreen | App version, server URL, tap-to-copy |

### App Components

| Component | File | Purpose |
|-----------|------|---------|
| ChatView | `src/components/ChatView.tsx` | Message list, tool bubbles, plan approval card |
| TerminalView | `src/components/TerminalView.tsx` | Raw terminal output display |
| InputBar | `src/components/InputBar.tsx` | Text input with send/interrupt toggle |
| SettingsBar | `src/components/SettingsBar.tsx` | Collapsible bar: model/permission/cost/agents |
| SessionPicker | `src/components/SessionPicker.tsx` | Horizontal session tab strip |
| MarkdownRenderer | `src/components/MarkdownRenderer.tsx` | Markdown parsing + inline code highlighting |
| CreateSessionModal | `src/components/CreateSessionModal.tsx` | New session creation dialog |

### State Management (Zustand)

Key state: `connectionPhase` (ConnectionPhase enum), `wsUrl`, `apiToken`, `viewMode`, `messages[]`, `terminalBuffer`

`ConnectionPhase`: `disconnected` ‚Üí `connecting` ‚Üí `connected` / `reconnecting` / `server_restarting`
`selectShowSession`: stays on SessionScreen during transient disconnects (reconnecting/server_restarting)

## Dev Commands

```bash
# From project root:

# Server (use Node 22!)
PATH="/opt/homebrew/opt/node@22/bin:$PATH" npm run server:dev

# App (iOS)
npm run app:ios

# App (Android)
npm run app:android

# Or from individual packages:

# Server (packages/server/)
PATH="/opt/homebrew/opt/node@22/bin:$PATH" npm run dev

# App (packages/app/)
npx expo start

# Test client (validate server without mobile app)
node packages/server/src/test-client.js wss://your-url
```

## Project Files Reference

### Server (`packages/server/src/`)

| File | Purpose |
|------|---------|
| `cli.js` | CLI commands (init, start, config, tunnel setup) |
| `config.js` | Config schema validation + merge precedence |
| `supervisor.js` | Supervisor: tunnel owner + child auto-restart |
| `server-cli-child.js` | Supervised child entry point |
| `server-cli.js` | CLI mode orchestrator |
| `cli-session.js` | Claude Code headless executor (stream-json) |
| `sdk-session.js` | Claude Agent SDK executor |
| `push.js` | Push notifications via Expo Push API |
| `server.js` | PTY mode orchestrator |
| `pty-manager.js` | PTY/tmux management |
| `pty-session.js` | PTY session state + I/O handling |
| `output-parser.js` | Terminal output parser |
| `noise-patterns.js` | Terminal noise filter patterns |
| `ws-server.js` | WebSocket protocol with auth |
| `tunnel.js` | Cloudflare tunnel manager (quick/named/none) |
| `tunnel-check.js` | Tunnel health verification |
| `tunnel-events.js` | Tunnel event wiring helpers |
| `session-manager.js` | Session lifecycle management |
| `session-discovery.js` | Session discovery utilities |
| `models.js` | Model switching utilities |
| `logger.js` | Shared logging utility |

### App (`packages/app/src/`)

| File | Purpose |
|------|---------|
| `App.tsx` | App root with navigation |
| `screens/ConnectScreen.tsx` | QR scan + manual connection UI |
| `screens/SessionScreen.tsx` | Session orchestrator (wires components) |
| `screens/SettingsScreen.tsx` | App settings and version info |
| `components/ChatView.tsx` | Message list, tool bubbles, plan approval card |
| `components/TerminalView.tsx` | Raw terminal output display |
| `components/InputBar.tsx` | Text input with send/interrupt toggle |
| `components/SettingsBar.tsx` | Collapsible bar: model/permission/cost/agents |
| `components/SessionPicker.tsx` | Horizontal session tab strip |
| `components/MarkdownRenderer.tsx` | Markdown parsing + inline code highlighting |
| `components/CreateSessionModal.tsx` | New session creation dialog |
| `store/connection.ts` | Zustand state store (ConnectionPhase) |
| `notifications.ts` | Push notification registration |
| `constants/colors.ts` | Shared color palette |
| `constants/icons.ts` | Shared icon constants |

### Docs

| File | Purpose |
|------|---------|
| `CLAUDE.md` | This file |
| `docs/qa-log.md` | QA audit log with coverage matrix |
| `docs/smoke-test.md` | Manual smoke test checklist |
| `docs/named-tunnel-guide.md` | Named tunnel setup guide |
| `docs/architecture/in-app-dev.md` | In-app iterative development design |

---

*Last Updated: 2026-02-10*
*Version: 0.1.0*
