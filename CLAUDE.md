# Claude Development Notes

Essential development notes for working with Claude on Chroxy.

## Project Overview

**Chroxy** is a remote terminal app for Claude Code. Run a lightweight daemon on your dev machine, connect from your phone via a secure tunnel. Get both a full terminal view and a clean chat-like UI that parses Claude Code's output into readable messages.

**Tech Stack:** Node.js (server), React Native/Expo (mobile app), WebSocket over ngrok tunnel

**Architecture:** Monorepo with npm workspaces

```
chroxy/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ server/     # Node.js daemon + CLI (ES modules, no TypeScript)
‚îÇ   ‚îî‚îÄ‚îÄ app/        # React Native mobile app (TypeScript, Expo 52)
‚îú‚îÄ‚îÄ docs/           # Setup guides, architecture
‚îî‚îÄ‚îÄ scripts/        # Install helpers
```

**Current Status (v0.1.0):**
- Server works: PTY management, output parsing, WebSocket protocol, ngrok tunnel, CLI
- App is a shell: navigation, connection screen, session screen with chat/terminal views
- Priority: QR scanning, connection flow testing, output parser tuning

## Critical Dev Notes

### Node 22 Required

**node-pty does not compile on Node 25.** Always use Node 22:

```bash
PATH="/opt/homebrew/opt/node@22/bin:$PATH" npx chroxy start
```

Or prefix any npm/node commands with the Node 22 path when running the server.

### tmux Dependency

tmux must be installed. The server spawns/attaches to tmux sessions for persistent Claude Code instances.

```bash
brew install tmux
```

## Session Start Protocol

**When user says "Resume" or "Let's start":**
1. `cat CLAUDE.md` - Read this file
2. `git status && git log --oneline -5` - Check current state
3. Review any open PRs: `gh pr list`

## Git Workflow

### Zero Attribution Policy

**CRITICAL - READ THIS FIRST:**

Claude must NEVER include ANY of the following in commits, PRs, or any files:
- `Co-Authored-By: Claude` or any Claude co-author line
- `Generated with Claude Code` or similar phrases
- `Generated by Claude` or `Created by Claude`
- Any emoji + "Generated with" pattern
- Any mention of Claude, Anthropic, or AI assistance in commit messages
- Any attribution in PR descriptions

**The user is the SOLE AUTHOR of all work. Period.**

Commit messages should be clean and professional:
```
feat(server): add graceful shutdown on SIGTERM

- Clean up tmux session on exit
- Close WebSocket connections
```

NOT:
```
feat: Add feature

ü§ñ Generated with [Claude Code](...)

Co-Authored-By: Claude...
```

### Branch Naming

```
feat/feature-name         # New features
fix/issue-description     # Bug fixes
refactor/component        # Refactoring
docs/topic                # Documentation
test/test-description     # Test additions
```

### Commit Message Format

```
type(scope): Short summary in present tense

[Optional body with details]
```

**Types:** feat, fix, refactor, docs, test, chore, style, perf
**Scopes:** server, app, parser, tunnel, ws, cli, docs

### PR Workflow

**CRITICAL: NEVER commit directly to main.** Always use feature branches and PRs.

1. Create feature branch from `main`
2. Develop and test
3. Push and create PR
4. Get user confirmation before merging
5. Squash merge to main

**NEVER auto-merge.** Always present a summary and wait for explicit user confirmation.

## Code Style

### Server (packages/server/)

- ES modules (`import`/`export`)
- No TypeScript ‚Äî plain JavaScript
- No semicolons
- Single quotes for strings
- EventEmitter pattern for component communication

### App (packages/app/)

- TypeScript (strict)
- Functional components with hooks
- Zustand for state management
- React Navigation for routing

## Architecture

### Server Components

| Component | File | Purpose |
|-----------|------|---------|
| CLI | `src/cli.js` | `init`, `start`, `config` commands |
| Server | `src/server.js` | Orchestrates all components |
| WsServer | `src/ws-server.js` | WebSocket protocol with auth |
| PtyManager | `src/pty-manager.js` | tmux session management |
| OutputParser | `src/output-parser.js` | Claude Code output ‚Üí structured messages |
| TunnelManager | `src/tunnel.js` | ngrok tunnel lifecycle |

### Data Flow

```
[Mobile App] ‚ÜêWebSocket‚Üí [ngrok] ‚Üê‚Üí [WsServer]
                                        ‚Üï
                              [PtyManager] ‚Üí [OutputParser]
                                   ‚Üï              ‚Üï
                              [tmux/Claude]   [Parsed Messages]
```

### WebSocket Protocol

Client ‚Üí Server: `auth`, `input`, `resize`, `mode`
Server ‚Üí Client: `auth_ok`, `auth_fail`, `raw`, `message`, `status`

### App Screens

| Screen | Purpose |
|--------|---------|
| ConnectScreen | QR scan or manual URL/token entry |
| SessionScreen | Dual-view: chat mode + terminal mode |

### State Management (Zustand)

Key state: `isConnected`, `wsUrl`, `apiToken`, `viewMode`, `messages[]`, `terminalBuffer`

## Dev Commands

```bash
# Server (use Node 22!)
PATH="/opt/homebrew/opt/node@22/bin:$PATH" npm run server:dev

# App
npm run app:ios
npm run app:android

# Test client (validate server without mobile app)
node packages/server/src/test-client.js wss://your-url
```

## Project Files Reference

| File | Purpose |
|------|---------|
| `packages/server/src/server.js` | Main server orchestration |
| `packages/server/src/output-parser.js` | Claude Code output parser (needs tuning) |
| `packages/server/src/ws-server.js` | WebSocket protocol |
| `packages/server/src/pty-manager.js` | PTY/tmux management |
| `packages/server/src/tunnel.js` | ngrok tunnel |
| `packages/server/src/cli.js` | CLI commands |
| `packages/app/src/App.tsx` | App root with navigation |
| `packages/app/src/screens/ConnectScreen.tsx` | Connection setup UI |
| `packages/app/src/screens/SessionScreen.tsx` | Main session UI |
| `packages/app/src/store/connection.ts` | Zustand state store |
| `CLAUDE.md` | This file |

---

*Last Updated: 2026-02-05*
*Version: 0.1.0*
