#!/usr/bin/env node

/**
 * Reads xterm.js, FitAddon, and xterm.css from node_modules and writes them
 * as exported string constants to src/components/xterm-bundle.generated.ts.
 *
 * Run via: npm run bundle-xterm (also runs automatically as postinstall)
 */

const { readFileSync, writeFileSync } = require('fs')
const { join } = require('path')

// Resolve from node_modules (works with hoisting)
const xtermCssPath = require.resolve('@xterm/xterm/css/xterm.css')
const xtermJsPath = require.resolve('@xterm/xterm/lib/xterm.js')
const fitAddonJsPath = require.resolve('@xterm/addon-fit/lib/addon-fit.js')

const xtermCss = readFileSync(xtermCssPath, 'utf-8')
const xtermJs = readFileSync(xtermJsPath, 'utf-8')
const fitAddonJs = readFileSync(fitAddonJsPath, 'utf-8')

// Read actual installed versions from package.json
const xtermVersion = require('@xterm/xterm/package.json').version
const fitAddonVersion = require('@xterm/addon-fit/package.json').version

// Escape backticks and ${} for template literal safety
function escapeForTemplate(str) {
  return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$\{/g, '\\${')
}

const output = `// Auto-generated by scripts/bundle-xterm.js â€” do not edit manually
// Source: @xterm/xterm@${xtermVersion}, @xterm/addon-fit@${fitAddonVersion}

export const XTERM_CSS = \`${escapeForTemplate(xtermCss)}\`

export const XTERM_JS = \`${escapeForTemplate(xtermJs)}\`

export const FIT_ADDON_JS = \`${escapeForTemplate(fitAddonJs)}\`
`

const outPath = join(__dirname, '..', 'src', 'components', 'xterm-bundle.generated.ts')
writeFileSync(outPath, output, 'utf-8')

console.log(`[bundle-xterm] Wrote ${(output.length / 1024).toFixed(1)}KB to src/components/xterm-bundle.generated.ts`)
