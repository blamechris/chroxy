# Chroxy Codebase Audit Report

**Date:** 2026-02-08
**Version:** 0.1.0
**Commit:** `eb4a6c0` (HEAD of main)
**Scope:** Full codebase — server, app, docs, tests, CI/CD, security, architecture

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Project Vital Signs](#project-vital-signs)
3. [Architecture Assessment](#architecture-assessment)
4. [Server Package Review](#server-package-review)
5. [App Package Review](#app-package-review)
6. [Test Coverage & QA](#test-coverage--qa)
7. [Security Review](#security-review)
8. [What's Working Well](#whats-working-well)
9. [What Needs Improvement](#what-needs-improvement)
10. [Roadmap Status & Gap Analysis](#roadmap-status--gap-analysis)
11. [Recommended Next Steps](#recommended-next-steps)
12. [File-by-File Risk Matrix](#file-by-file-risk-matrix)

---

## Executive Summary

Chroxy is a well-architected v0.1.0 project with a clean monorepo structure, solid dual-mode server design, and a functional React Native app. The codebase is ~7,500 LOC across 21 source files, written in 4 days of intense development (32 PRs merged since 2026-02-05). Code quality is generally high with consistent style, good separation of concerns, and an EventEmitter-driven server architecture.

**Overall Grade: B+**

| Area | Rating | Summary |
|------|--------|---------|
| Architecture | A | Clean dual-mode design, good abstractions |
| Server Code | B+ | Solid but has platform-specific issues and some silent failures |
| App Code | A- | Excellent Zustand store, sophisticated state management |
| Test Coverage | D | 2 test files covering 2 of 12 server modules; zero app tests |
| Security | B | Token auth works, but plaintext storage and missing input validation |
| Documentation | A | CLAUDE.md, smoke tests, QA log, CONTRIBUTING.md all excellent |
| CI/CD | F | No automated pipelines at all |
| QA Process | B- | Comprehensive checklist exists, but only 2 of 11 scopes tested |

---

## Project Vital Signs

| Metric | Value |
|--------|-------|
| Total LOC (source) | ~7,470 |
| Server source files | 12 (JavaScript, ES modules) |
| App source files | 7 (TypeScript, React Native) |
| Test files | 2 (server only) |
| Dependencies (server) | 6 |
| Dependencies (app) | 11 + 4 dev |
| Commits since inception | 32 |
| PRs merged | 30+ (numbered to #93) |
| Dev velocity | ~8 PRs/day over 4 days |
| Largest files | `SessionScreen.tsx` (1582), `connection.ts` (1129), `ws-server.js` (1108) |

### Development Timeline

```
2026-02-05  Initial commit + CLI headless mode (#12, #13)
2026-02-06  Core features: model switching, permissions, chat UX (#14-#35)
2026-02-07  Polish: parser hardening, reconnection, selection UX (#38-#76)
2026-02-08  Docs, refactoring, PTY status bar (#81-#93)
```

---

## Architecture Assessment

### Dual-Mode Server Design: EXCELLENT

The decision to support both CLI headless (default) and PTY/tmux modes is architecturally sound. CLI mode covers the primary use case (headless `claude -p` with structured JSON) with minimal dependencies, while PTY mode preserves full terminal access for power users.

```
CLI Mode (default):       PTY Mode (--terminal):
  App ↔ WS ↔ CliSession    App ↔ WS ↔ PtySession
              ↕                        ↕
         claude -p             tmux + Claude Code
      (stream-json)            (raw terminal)
```

**Key strengths:**
- SessionManager abstracts both session types behind a common interface
- WS protocol works identically regardless of backend mode
- CLI mode has zero native dependencies (no node-pty/tmux)

**Key concern:**
- The two modes have significantly different feature sets (model switching, permissions only in CLI mode). This divergence will grow unless PTY mode gets feature parity or is clearly positioned as secondary.

### WebSocket Protocol: COMPREHENSIVE

The protocol covers auth, streaming, sessions, models, permissions, and status updates — 28+ message types. It's well-documented in `ws-server.js` comments. The permission system using a shell hook + HTTP long-poll bridge is creative and works well.

### Monorepo Structure: CLEAN

npm workspaces with two packages is the right call. Root package.json has convenience scripts. No build step needed for the server (raw ES modules).

---

## Server Package Review

### Module Quality Summary

| Module | Lines | Quality | Key Issue |
|--------|-------|---------|-----------|
| `cli.js` | 169 | Good | No config schema validation |
| `index.js` | 16 | Fine | Dev-only entry point |
| `server-cli.js` | 125 | Good | Tunnel failure not loud enough |
| `cli-session.js` | 689 | Good | Respawn timeout hang risk; silent permission hook failures |
| `ws-server.js` | 1108 | Good | No message size limits; health endpoint unauthenticated |
| `session-manager.js` | 350 | Very Good | History ring buffer limited to 100 entries |
| `pty-manager.js` | 114 | Needs Work | Hardcoded `/opt/homebrew/bin/tmux` (M1 Mac only) |
| `pty-session.js` | 173 | Good | Thin adapter, works well |
| `output-parser.js` | 607 | Impressive but Fragile | 50+ regex patterns, brittle to Claude UI changes |
| `session-discovery.js` | 126 | Adequate | Platform-specific commands (pgrep, lsof) |
| `tunnel.js` | 85 | Good | No auto-recovery on tunnel crash |
| `tunnel-check.js` | 31 | Good | Only checks HTTP, not WebSocket |
| `models.js` | 32 | Excellent | Simple, correct, no issues |
| `test-client.js` | 73 | Fine | Useful debug tool |

### Critical Issues

**1. Hardcoded macOS paths in `pty-manager.js`**
- Lines 33, 41, 42: `/opt/homebrew/bin/tmux` — fails on Intel Macs, Linux, WSL
- **Impact:** PTY mode is completely broken on non-Apple-Silicon Macs
- **Fix:** Use `which tmux` or search `PATH`

**2. Respawn hang risk in `cli-session.js`**
- `setModel()` kills the process and waits for `close` event to respawn
- If the process hangs on exit, model change blocks forever (no timeout)
- **Impact:** Model switching can deadlock the session
- **Fix:** Add 10s timeout on respawn wait, force-kill if exceeded

**3. Silent permission hook failure in `cli-session.js`**
- If `~/.claude/settings.json` is corrupt, hook registration silently skips
- User has no indication their permission routing is broken
- **Impact:** Permissions silently stop working
- **Fix:** Emit error event or log warning to console.error

### Medium Issues

**4. No tunnel auto-recovery (`tunnel.js`)**
- If cloudflared crashes, server continues on localhost only with no notification
- Users can't reconnect remotely until manual server restart

**5. No WebSocket message size limits (`ws-server.js`)**
- `input` messages have no size cap; could receive 1MB+ payloads
- HTTP `/permission` endpoint has 64KB limit, but WS does not

**6. Output parser fragility (`output-parser.js`)**
- 50+ regex patterns for noise filtering, tightly coupled to Claude Code's terminal UI
- Any Claude Code UI update could break parsing
- The parser is 607 lines of carefully tuned heuristics — impressive work, but high maintenance burden

**7. Config schema not validated (`cli.js`)**
- `~/.chroxy/config.json` parsed without validation; missing fields cause runtime errors
- Environment variable precedence (CLI args vs env vs config) is unclear

### Minor Issues

- Auth timeout not cleared on successful auth (`ws-server.js:180`) — fires harmlessly but wasteful
- Error suppression in cleanup code (`try { ws.terminate() } catch {}`) makes debugging harder
- `package.json` engine field says `>=18` but Node 22 is required for PTY mode
- History ring buffer discards messages after 100 entries with no size-based alternative

---

## App Package Review

### Module Quality Summary

| Module | Lines | Quality | Key Issue |
|--------|-------|---------|-----------|
| `App.tsx` | 46 | Clean | Minimal, correct |
| `ConnectScreen.tsx` | 385 | Good | URL validation minimal |
| `SessionScreen.tsx` | 1582 | Good but Large | Should be split into sub-components |
| `connection.ts` | 1129 | Excellent | Sophisticated multi-session state management |
| `SessionPicker.tsx` | 201 | Good | Clean modal component |
| `CreateSessionModal.tsx` | 321 | Good | Proper validation |

### Strengths

**Zustand store (`connection.ts`) is the standout file in the codebase:**
- Dual-mode state architecture (flat + hierarchical for session switching)
- Connection attempt IDs prevent stale socket race conditions
- Delta batching (100ms windows) reduces re-renders during streaming
- History replay deduplication on reconnect
- Secure storage for credentials via `expo-secure-store`
- Context usage tracking (tokens, cost, duration)

**Chat UI (`SessionScreen.tsx`) is feature-rich:**
- Activity groups with expand/collapse
- Message selection with copy/share/export
- Inline markdown rendering (bold, code, headers, lists)
- Fenced code blocks with language labels
- Collapsible settings bar with model chips
- Permission prompt cards with Allow/Deny/Always Allow
- Enter-to-send vs Enter-for-newline toggle

### Issues

**1. SessionScreen.tsx is 1582 lines — too large**
- Contains: ChatView, TerminalView, MessageBubble, ActivityGroup, FormattedTextBlock, MarkdownBlock, settings bar, input bar, permission UI
- Should be split into 5-6 focused component files
- **Impact:** Hard to navigate, review, and maintain

**2. Terminal view is plain text only**
- No colors, cursor positioning, or text regions
- Processes `\r` for line overwriting but that's all
- Explicitly acknowledged as a TODO (xterm.js)

**3. Markdown rendering gaps**
- Supports: bold, inline code, headers, lists (ordered/unordered/task), code blocks
- Missing: links, tables, blockquotes, strikethrough, emphasis (`*italic*`), images
- No syntax highlighting in code blocks

**4. WebSocket errors not shown to user**
- `socket.onerror` logs to console but doesn't show an alert
- Users see connection drop but not why

**5. No app tests**
- Jest + jest-expo configured but zero test files exist
- Store logic (`connection.ts`) is complex enough to warrant unit tests

**6. Unused dependency**
- `react-native-webview` is still in `package.json` (removed from code in PR #71)
- Should be fully removed or kept only if xterm.js work is imminent

---

## Test Coverage & QA

### Automated Tests

| Scope | Files | Coverage | Notes |
|-------|-------|----------|-------|
| Output parser | `output-parser.test.js` | Good | ANSI stripping, noise filtering, dedup |
| Models | `models.test.js` | Complete | All model ID resolution paths covered |
| CLI session | -- | None | Complex module, most needs testing |
| WS server | -- | None | Auth, protocol, edge cases untested |
| Session manager | -- | None | Multi-session lifecycle untested |
| Tunnel | -- | None | |
| App store | -- | None | Complex Zustand logic untested |
| App screens | -- | None | |

**Estimated coverage: ~15% of server code, 0% of app code**

### Manual QA

The `docs/smoke-test.md` checklist is comprehensive (300+ lines, 11 test scopes, 80+ individual checks). However, the `docs/qa-log.md` shows only **2 of 11 scopes have been tested:**

| Scope | Status | Risk |
|-------|--------|------|
| Regression Baseline | PASS | Low |
| Chat | PASS | Low |
| Connection | Untested | Medium — reconnection logic is complex |
| Permissions | Untested | High — permission hook is a security boundary |
| Model Switching | Untested | Medium — involves process respawn |
| Cost/Usage | Untested | Low |
| No-Auth Mode | Untested | Medium — security implications |
| Message Selection | Untested | Low |
| Input Modes | Untested | Low |
| Terminal (PTY) | Untested | High — PTY mode has known platform issues |
| Shutdown/Cleanup | Untested | Medium — hook cleanup is critical |

### CI/CD

**There is no CI/CD pipeline.** No GitHub Actions, no automated tests on PR, no lint checks, no build verification. The `.github/` directory contains only issue templates.

---

## Security Review

### Authentication: B+

| Aspect | Status | Notes |
|--------|--------|-------|
| Token generation | Good | UUID v4 via `chroxy init` |
| Token validation | Good | Required on every WS message |
| Auth timeout | Good | 10s timeout on unauthenticated connections |
| No-auth mode | Adequate | Localhost-only binding, clear warnings |
| Token storage (server) | Weak | Plaintext in `~/.chroxy/config.json` |
| Token storage (app) | Good | `expo-secure-store` (OS keychain) |

### Input Validation: C+

| Aspect | Status | Notes |
|--------|--------|-------|
| Model IDs | Good | Validated against whitelist |
| Permission modes | Good | Validated against whitelist |
| Directory paths | Good | `statSync` check before use |
| Session names | Adequate | Used in UI only, not shell commands |
| WS message types | Missing | No whitelist — unknown types silently ignored |
| WS message size | Missing | No per-message size limit |
| JSON parsing | Adequate | try/catch but no schema validation |

### Potential Vulnerabilities

1. **Shell injection in `pty-manager.js`** — `execSync` with template literals. Currently safe because session names are UUID-derived, but fragile if extended.
2. **Shell injection in `session-discovery.js`** — `execSync` with tmux session names from system output. Low risk but no sanitization.
3. **Permission hook JSON parsing** — Uses `grep` instead of `jq`; could be confused by crafted payloads. Low practical risk.
4. **Health endpoint unauthenticated** — `GET /health` reveals server is running. Acceptable for tunnel verification but could be restricted.

### Recommendations

- Add `maxPayload` option to WS server constructor (ws library supports this)
- Validate message type against whitelist before processing
- Consider encrypting config.json or using macOS Keychain for token storage
- Add `jq` fallback in `permission-hook.sh` for robust JSON parsing

---

## What's Working Well

1. **CLI headless mode is production-ready** — Zero native dependencies, structured JSON streaming, model switching, permission handling, session management all work
2. **WebSocket protocol is comprehensive** — 28+ message types covering auth, streaming, sessions, models, permissions, and status
3. **Zustand store is excellent** — Multi-session state, delta batching, reconnection handling, secure storage
4. **Chat UI is polished** — Message grouping, selection, markdown rendering, activity groups, collapsible settings
5. **Documentation is thorough** — CLAUDE.md, 300-line smoke test checklist, QA audit log, CONTRIBUTING guide
6. **Development velocity is exceptional** — 32 PRs in 4 days, clean commit history, consistent PR workflow
7. **Permission system is creative** — Shell hook + HTTP long-poll bridge is elegant
8. **QR code onboarding** — Scan-to-connect is great UX for mobile pairing
9. **Reconnection logic** — Saved credentials, auto-reconnect, history preservation
10. **Dual-view UI** — Chat and terminal modes serve different user needs

---

## What Needs Improvement

### High Priority

1. **Test coverage is critically low** — 2 test files for a 7,500 LOC project. The Zustand store and WS server are complex enough to need automated tests.

2. **No CI/CD** — Every PR is untested. A basic pipeline (lint + test + type-check) would catch regressions.

3. **PTY mode is platform-locked** — Hardcoded `/opt/homebrew/bin/tmux` makes PTY mode M1-Mac-only. Either fix the paths or clearly document it as macOS-only.

4. **Tunnel has no auto-recovery** — If cloudflared crashes, remote access dies silently. Need health monitoring + auto-restart.

5. **Output parser maintenance burden** — 607 lines of regex tied to Claude Code's terminal UI. Any Claude update breaks this. Consider versioning or making patterns configurable.

### Medium Priority

6. **SessionScreen.tsx needs splitting** — 1582 lines in one component is hard to maintain. Extract ChatView, TerminalView, MessageBubble, SettingsBar into separate files.

7. **Terminal view is plain text** — The xterm.js integration (already on roadmap) is needed for a proper terminal experience. Currently no colors, cursor, or scrolling regions.

8. **Markdown gaps** — Missing links, tables, and syntax highlighting. Claude outputs all of these frequently.

9. **QA coverage** — 9 of 11 smoke test scopes remain untested. Permissions and shutdown/cleanup are especially important to verify.

10. **Config validation** — No schema validation for `~/.chroxy/config.json`. Corrupt or incomplete config causes opaque runtime errors.

### Lower Priority

11. **Error visibility in app** — WebSocket errors logged to console but not shown to users
12. **Session persistence** — Sessions lost on server restart; no auto-recovery
13. **Message history limits** — 100-entry ring buffer can lose context in long conversations
14. **No offline message queue** — Messages dropped if sent during brief disconnects

---

## Roadmap Status & Gap Analysis

### README Roadmap

| Item | Status | Gap Analysis |
|------|--------|-------------|
| Core server daemon with PTY management | Done | Working on M1 Mac only |
| Output parser for Claude Code patterns | Done | Fragile, needs hardening strategy |
| WebSocket protocol with auth | Done | Comprehensive, well-designed |
| Cloudflare tunnel integration | Done | No auto-recovery on crash |
| CLI with `init` and `start` commands | Done | Config validation missing |
| QR code generation for easy app pairing | Done | Good UX |
| React Native app with QR scanning | Done | Works well |
| Chat view with parsed messages | Done | Missing some markdown features |
| Terminal view (plain text) | Done | Very basic, no colors/cursor |
| One-tap reconnect with saved credentials | Done | Works well |
| **Terminal view with xterm.js** | **Not Started** | Biggest UX gap. WebView dependency removed. |
| **Scrollback buffer on reconnect** | **Not Started** | History replay exists but limited to 100 messages |
| **TestFlight / Play Store release** | **Not Started** | Expo config ready, no EAS setup |
| **Tailscale support** | **Not Started** | No work done |
| **Session recording and replay** | **Not Started** | No work done |

### CONTRIBUTING.md Roadmap (Additional Items)

| Item | Priority | Status |
|------|----------|--------|
| Syntax highlighting for code blocks | Easy Win | Not started |
| More special key buttons | Easy Win | Partially done (7 keys exist) |
| UI polish and animations | Easy Win | Ongoing |
| Enhanced markdown rendering | Medium | Partially done |
| Better error handling and recovery | Medium | Partially done |
| Session history and search | Medium | Not started |
| Push notifications | Larger | Not started |

### Missing from Roadmap (Identified in Audit)

These aren't on any current roadmap but should be considered:

| Item | Priority | Rationale |
|------|----------|-----------|
| CI/CD pipeline | High | Zero automated quality gates currently |
| Automated test suite | High | 15% coverage is risky for a growing codebase |
| PTY mode cross-platform support | Medium | Currently M1 Mac only |
| Tunnel auto-recovery | Medium | Remote access dies silently on crash |
| Config schema validation | Medium | Runtime errors from bad config |
| App component decomposition | Medium | SessionScreen.tsx is 1582 lines |
| WebSocket message size limits | Medium | DoS vector |
| Linux server support | Medium | Currently macOS-focused |

---

## Recommended Next Steps

### Phase 1: Stabilization (Before New Features)

**Goal:** Shore up foundations so new features don't break existing ones.

1. **Add CI pipeline** — GitHub Actions with: `npm test` (server), TypeScript type-check (app), lint check
2. **Expand test coverage** — Priority targets:
   - `cli-session.js` — Respawn logic, model switching, permission hook
   - `ws-server.js` — Auth flow, message routing, permission handling
   - `connection.ts` — Connection lifecycle, delta batching, session switching
3. **Run remaining QA scopes** — Especially: Permissions, Model Switching, Shutdown/Cleanup, Terminal (PTY)
4. **Fix PTY platform paths** — Replace hardcoded `/opt/homebrew/bin/tmux` with PATH lookup
5. **Add tunnel health monitoring** — Detect cloudflared crashes, auto-restart or notify user

### Phase 2: App Polish (User-Facing Quality)

**Goal:** Make the app feel complete for daily use.

6. **xterm.js terminal integration** — This is the single biggest UX gap. Plan:
   - Add `react-native-webview` back as dependency
   - Embed xterm.js in a WebView with bidirectional WS bridge
   - Support colors, cursor, scrollback, selection
7. **Syntax highlighting in code blocks** — Use a lightweight highlighter (e.g., Prism.js in WebView or regex-based)
8. **Split SessionScreen.tsx** — Extract into: `ChatView.tsx`, `TerminalView.tsx`, `MessageBubble.tsx`, `SettingsBar.tsx`, `InputBar.tsx`
9. **Add missing markdown features** — Links (tappable), tables, blockquotes
10. **Surface WebSocket errors to user** — Show alerts for connection failures with actionable messages

### Phase 3: Release Prep

**Goal:** Get to TestFlight / Play Store.

11. **EAS Build setup** — Configure `eas.json` for iOS and Android builds
12. **App icon and splash polish** — Verify assets at all resolutions
13. **Full QA pass** — All 11 smoke test scopes passing
14. **Version bump strategy** — Decide on semver approach (0.1.x patches vs 0.2.0)
15. **Privacy policy / terms** — Required for App Store submission

### Phase 4: Growth Features

16. **Scrollback buffer** — Persist more than 100 messages, load on scroll
17. **Push notifications** — Expo push for long-running task completion
18. **Session persistence** — Survive server restarts
19. **Tailscale support** — Alternative to Cloudflare tunnels
20. **Session recording and replay** — Record sessions for later review

---

## File-by-File Risk Matrix

Risk = (Complexity x Change Frequency x Test Coverage Gap)

| File | Lines | Complexity | Tests | Risk | Notes |
|------|-------|-----------|-------|------|-------|
| `connection.ts` | 1129 | High | None | **HIGH** | Most complex module, zero tests |
| `SessionScreen.tsx` | 1582 | High | None | **HIGH** | Largest file, needs splitting |
| `ws-server.js` | 1108 | High | None | **HIGH** | Security boundary, no tests |
| `cli-session.js` | 689 | High | None | **HIGH** | Process lifecycle, race conditions |
| `output-parser.js` | 607 | High | Partial | **MEDIUM** | Good tests but fragile patterns |
| `ConnectScreen.tsx` | 385 | Medium | None | MEDIUM | Auth flow, less complex |
| `session-manager.js` | 350 | Medium | None | MEDIUM | Session lifecycle |
| `CreateSessionModal.tsx` | 321 | Low | None | LOW | UI only |
| `SessionPicker.tsx` | 201 | Low | None | LOW | UI only |
| `pty-session.js` | 173 | Low | None | LOW | Thin adapter |
| `cli.js` | 169 | Low | None | LOW | CLI entry point |
| `session-discovery.js` | 126 | Medium | None | MEDIUM | Platform-specific |
| `server-cli.js` | 125 | Low | None | LOW | Orchestrator |
| `pty-manager.js` | 114 | Medium | None | MEDIUM | Platform-locked |
| `server.js` | 108 | Low | None | LOW | PTY orchestrator |
| `tunnel.js` | 85 | Low | None | LOW | Simple process wrapper |
| `test-client.js` | 73 | Low | N/A | -- | Debug tool |
| `App.tsx` | 46 | Low | None | LOW | Navigation only |
| `models.js` | 32 | Low | Complete | -- | Fully tested |
| `tunnel-check.js` | 31 | Low | None | LOW | Simple health check |
| `index.js` | 16 | Low | None | -- | Dev entry point |

---

*Generated 2026-02-08. Reference commit: `eb4a6c0`.*
